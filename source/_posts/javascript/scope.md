---
title: 你不知道的Javascript（上）读书记录
date: 2020-07-18 23:45:17
categories:
  - Javascript
tags:
  - 你不知道的Javascript
  - 读书笔记
---

# 第一章 作用域是什么

存放和查找变量和函数声明的规则的数据结构

## 1.1 编译原理

* 分词/词法分析（Tokenizing/Lexing）
  举例
```js
var a = 2; // 上面代码会被分为三个词法单元（token）：var、a、=、2、;。
```

* 解析/语法分析（Parsing）
  这个过程是将单元流（数组）转换成一个由元素逐级嵌套组成的代表了程序语法结构的树。这个树叫做抽象语法树（Abstract Syntax Tree，AST）。

* 代码生成（Code Generation）

  把抽象语法树转换成可执行代码的过程，就是转换成机器指令


## 1.2 理解作用域
三个角色：引擎、编译器、作用域

* 引擎：从头到尾负责整个JavaScript程序的编译及执行过程。
* 编译器：负责语法分析及代码生成等脏活累活。
* 作用域：负责收集并维护由所有声明的标识符（变量）组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限。

```js
var a = 2; // 编译器首先会将这段程序分解成词法单元，然后将词法单元解析成一个树形结构。
           // 当遇到var a 时，编译器会询问作用域是否已经有一个该名称的变量存在于同一个作用域的集合中。如果是，编译器会忽略该声明，继续进行编译；否则它会要求作用域在当前作用域的集合中声明一个新的变量，并命名为a。
           // 当编译器遇到 a = 2 时，编译器会为引擎生成运行时所需的代码，这些代码用来处理a = 2这个赋值操作。引擎运行时会首先询问作用域，在当前的作用域集合中是否存在一个叫作a的变量。如果是，引擎就会使用这个变量；如果否，引擎会继续查找该变量。如果在全局作用域中也没有找到a，引擎就会抛出一个异常。
```
**总结**： 变量赋值操作会执行两个动作，首先编译器会在当前作用域中声明一个变量（如果之前没有声明过），然后在运行时引擎会在作用域中查找该变量，如果能够找到就会对它赋值。

## LHS查询和RHS查询
LHS查询 赋值操作的目标
RHS查询 取到它的源值
* LHS查询：当变量出现在赋值操作的左侧时进行LHS查询。比如上面的例子中，a = 2 就是一个LHS查询。
* RHS查询：console.log(a)中的a就是RHS查询 RHS可以理解成 retrieve his source value（取到它的源值）。
```js
function foo(a) {
  var b = a;
  return a + b;
}
var c = foo(2);

// var c = foo(2)  c   LHS查询
// var c = foo(2)  foo RHS查询
// function foo(a) a LHS查询
// b = a b LHS查询 a RHS查询
// return a + b a和b 都是RHS查询

```
## 1.3 作用域嵌套

```js
function foo(a) { // a LHS查询 赋值2
  var b = a * 2;  // b LHS查询 赋值4  a RHS查询
  function bar(c) { // c LHS查询 赋值 12
    console.log(a, b, c); // a和b的RHS查询  当前作用域没有这两个变量，引擎需要向上级作用域查询
  }
  bar(b * 3); // b RHS查询
}
foo(2); // 2 4 12


```

## 1.4 异常

* ReferenceError：作用域查询失败时发生的错误，比如对未声明的变量进行RHS查询。对一个不存在的变量进行引用时发生的错误。 严格模式下LHS查询也会抛出ReferenceError异常。
* TypeError：作用域查询成功，但是对结果的操作是非法或者不合理的，比如对一个非函数类型的值进行函数调用。或者引用null或undefined类型的值中的属性。
## 1.5 小结
作用域是一套规则，用于确定在何处以及如何查找变量（标识符）。如果查找的目的是对变量进行赋值，那么就会使用LHS查询；如果目的是获取变量的值，就会使用RHS查询。
